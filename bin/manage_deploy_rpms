#!/usr/bin/env python2.6

import ConfigParser
import os.path
import socket
import sys

import beanstalkc
import daemonize
import sqlalchemy.orm.exc

from tagopsdb.database import init_session
from tagopsdb.database.meta import Session
from tagopsdb.exceptions import RepoException

import tagopsdb.deploy.repo as repo


def copy_package_to_repo(name, version):
    """ """

    host = socket.gethostname()

    with open('/etc/tagops/deploy.conf') as conf_file:
        config = ConfigParser.SafeConfigParser()
        config.readfp(conf_file)

    db_user = config.get('db', 'user')
    db_password = config.get('db', 'password')

    init_session(db_user, db_password)

    try:
        app = repo.list_app_location(name)
    except sqlalchemy.orm.exc.NoResultFound:
        raise RepoException('Application "%s" to not available in '
                            'PackageLocations table' % name)

    build_base = config.get('repo', 'build_base')
    repo_mountpoint = config.get('repo', 'repo_mountpoint')

    src_rpm = os.path.join(build_base, app.path, '%s.rpm' % app.pkg_name)
    dest_dir = repo_mountpoint  # May be more complex later, keeping
                                # simple assignment

    try:
        shutil.copy(src_rpm, dest_dir)
    except IOError, e:
        raise RepoException('Unable to copy file "%s" to "%s" on host "%s": '
                            '%s' % (src_rpm, dest_dir, host, e))


def main():
    """ """

    # Initialize beanstalk connection, set up use and watch tubes
    beanstalk = beanstalkc.Connection(host='tong01.tagged.com', port=11300)
    beanstalk.use('tds.package.error')
    beanstalk.watch('tds.package.copy')
    beanstalk.ignore('default')

    while True:
        job = beanstalk.reserve()
        daemonize.logging.info("Received: %s" % job.body)

        try:
            id, name, version = job.body.split(' ')
        except ValueError:
            daemonize.logging.error('Invalid message in queue '
                                    'tds.package.copy: %s' % job.body)
            job.delete()
            beanstalk.put('%s ERROR Invalid message in queue '
                          'tds.package.copy: %s' % (id, job.body))
            continue

        try:
            copy_package_to_repo(name, version)
        except RepoException, e:
            daemonize.logging.error(e)
            job.delete()
            beanstalk.put('%s ERROR Queue tds.package.copy: %s' % (id, e))
            continue

        # All good, just delete job
        job.delete()

        # Send update repo request to server
        beanstalk.use('tds.package.update')
        beanstalk.put('updaterepo')
        beanstalk.use('tds.package.error')


pid = '/var/run/manage_deploy_rpms.pid'
logfile = '/var/log/manage_deploy_rpms.log'

daemonize.start(main, pid, logfile)
