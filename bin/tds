#!/usr/bin/env python

import argparse
import ConfigParser
import getpass
import os
import pwd
import sys

import tds.commands

from tagopsdb.database import init_session
from tagopsdb.exceptions import PermissionsException
from tds.authorize import get_access_level
from tds.cmdline import parser_info
from tds.exceptions import AccessError, NotImplementedError, \
                           WrongEnvironmentError


def create_subparsers(parser):
    """ """

    data = parser_info()

    cmd_parsers = parser.add_subparsers(dest='command_name',
                                        help='command help')

    for cmd, cmd_data in data.iteritems():
        cmd_parser = cmd_parsers.add_parser(cmd)

        subparsers = cmd_parser.add_subparsers(dest='subcommand_name',
                                               help='subcommand help')

        for subcmd, subcmd_data in cmd_data.iteritems():
            subcmd_parser = subparsers.add_parser(subcmd,
                                                  help=subcmd_data['help'])

            for args, kwargs in subcmd_data['subargs'].iteritems():
                subcmd_parser.add_argument(*args, **kwargs)


def parse_command_line():
    """ """

    parser = argparse.ArgumentParser(description='TagOps Deployment System')

    parser.add_argument('-v', '--verbose', action='store_true',
                        help='Show more information')
    # If we want multiple verbose levels, use next line instead
    #parser.add_argument('-v', '--verbose', action='count')
    parser.add_argument('--dbuser', help='Specify user to use to connect '
                                         'to TagOpsDB',
                                    default=None)

    create_subparsers(parser)

    # Temporary reference info, not meant to be used
    #create_subparser(parser_tagconfig,
    #                 { 'add' : ('env', 'revision'),
    #                   'push' : ('env', 'revision', 'apptype'), })

    return parser.parse_args()


def check_user_auth(user):
    """ """

    user_level = get_access_level()

    if user_level is None:
        print 'Your account (%s) is not allowed to run this application.\n' \
              'Please refer to your manager for assistance.' % user
        sys.exit(1)

    return user_level


def get_environment():
    """ """

    with open('/etc/tagops/deploy.conf') as conf_file:
        config = ConfigParser.SafeConfigParser()
        config.readfp(conf_file)

    return config.get('env', 'environment')


def initialize_db(args):
    """ """

    if args.dbuser:
        db_user = args.dbuser
        db_password = args.dbpassword
    else:
        dbaccess_file = '/etc/tagops/dbaccess.%s.conf' % args.user_level
        with open(dbaccess_file) as conf_file:
            config = ConfigParser.SafeConfigParser()
            config.readfp(conf_file)

        db_user = config.get('db', 'user')
        db_password = config.get('db', 'password')

    try:
        init_session(db_user, db_password, echo=args.verbose)
    except PermissionsException, e:
        print 'Access issue with database:'
        print e
        sys.exit(1)


if __name__ == '__main__':
    args = parse_command_line()

    # Slight hack: ensure '--hosts' and '--apptypes' aren't used
    # at the same time
    if getattr(args, 'hosts', None) and getattr(args, 'apptypes', None):
        print 'The "--hosts" and "--apptypes" options may not be used ' \
              'at the same time'
        sys.exit(1)

    # Pass user through with arguments
    args.user = pwd.getpwuid(os.getuid()).pw_name
    args.user_level = check_user_auth(args.user)
    args.environment = get_environment()
    print "args are: %s" % args   # Remove once main code is written

    if args.dbuser:
        args.dbpassword = getpass.getpass('Enter DB password: ')

    initialize_db(args)
    cmd = getattr(tds.commands, args.command_name.capitalize())()

    try:
        getattr(cmd, args.subcommand_name.replace('-', '_'))(args)
    except AccessError:
        print 'Your account (%s) does not have the appropriate permissions' \
              '\nto run the requested command.' % args.user
        sys.exit(1)
    except (NotImplementedError, WrongEnvironmentError), e:
        print e
        sys.exit(1)
