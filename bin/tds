#!/usr/bin/env python

import argparse
import ConfigParser
import os
import pwd
import sys

import tds.commands

from tagopsdb.database import init_session
from tds.authorize import get_access_level
from tds.cmdline import parser_info
from tds.exceptions import AccessError


def create_subparsers(parser):
    """ """

    data = parser_info()

    cmd_parsers = parser.add_subparsers(dest='command_name',
                                        help='command help')

    for cmd, cmd_data in data.iteritems():
        cmd_parser = cmd_parsers.add_parser(cmd)

        subparsers = cmd_parser.add_subparsers(dest='subcommand_name',
                                               help='subcommand help')

        for subcmd, subcmd_data in cmd_data.iteritems():
            subcmd_parser = subparsers.add_parser(subcmd,
                                                  help=subcmd_data['help'])

            for args, kwargs in subcmd_data['subargs'].iteritems():
                subcmd_parser.add_argument(*args, **kwargs)


def parse_command_line():
    """ """

    parser = argparse.ArgumentParser(description='TagOps Deployment System')

    parser.add_argument('-v', '--verbose', help='Show more information')
    # If we want multiple verbose levels, use next line instead
    #parser.add_argument('-v', '--verbose', action='count')
    parser.add_argument('--dbuser', help='Specify user to use to connect '
                                         'to TagOpsDB',
                                    default=None)

    create_subparsers(parser)

    # Temporary reference info, not meant to be used
    #create_subparser(parser_tagconfig,
    #                 { 'add' : ('env', 'revision'),
    #                   'push' : ('env', 'revision', 'apptype'), })

    return parser.parse_args()


def initialize_db(user):
    """ """

    user_level = get_access_level()

    if user_level is None:
        print 'Your account (%s) is not allowed to run this application.\n' \
              'Please refer to your manager for assistance.' % user
        sys.exit(1)

    with open('/etc/tagops/dbaccess.%s.conf' % user_level) as conf_file:
        config = ConfigParser.SafeConfigParser()
        config.readfp(conf_file)

    db_user = config.get('db', 'user')
    db_password = config.get('db', 'password')

    init_session(db_user, db_password)

    return user_level


if __name__ == '__main__':
    args = parse_command_line()

    # Pass user through with arguments
    args.user = pwd.getpwuid(os.getuid()).pw_name
    print "args are: %s" % args   # Remove once main code is written

    args.user_level = initialize_db(args.user)
    cmd = getattr(tds.commands, args.command_name.capitalize())()

    try:
        getattr(cmd, args.subcommand_name.replace('-', '_'))(args)
    except AccessError:
        print 'Your account (%s) does not have the appropriate permissions' \
              '\nto run the requested command.' % args.user
        sys.exit(1)
    except NotImplementedException, e:
        print e
        sys.exit(1)
