#!/usr/bin/env python

import argparse
import ConfigParser
import getpass
import os
import pwd
import sys

import tds.commands
import tds.version

from tagopsdb.database import init_session
from tagopsdb.exceptions import PermissionsException
from tds.authorize import get_access_level
from tds.cmdline import parser_info
from tds.exceptions import AccessError, NotImplementedError, \
                           WrongEnvironmentError, WrongProjectTypeError


def create_subparsers(parser):
    """ """

    data = parser_info()

    cmd_parsers = parser.add_subparsers(dest='command_name',
                                        help='command help')

    for cmd, cmd_data in data.iteritems():
        cmd_parser = cmd_parsers.add_parser(cmd)

        subparsers = cmd_parser.add_subparsers(dest='subcommand_name',
                                               help='subcommand help')

        for subcmd, subcmd_data in cmd_data.iteritems():
            subcmd_parser = subparsers.add_parser(subcmd,
                                                  help=subcmd_data['help'])

            for args, kwargs in subcmd_data['subargs'].iteritems():
                subcmd_parser.add_argument(*args, **kwargs)


def parse_command_line():
    """ """

    parser = argparse.ArgumentParser(description='TagOps Deployment System')

    parser.add_argument('-V', '--version', action='version',
                        version='TDS %s' % tds.version.__version__)
    parser.add_argument('-v', '--verbose', action='store_true',
                        help='Show more information')
    # If we want multiple verbose levels, use next line instead
    #parser.add_argument('-v', '--verbose', action='count')
    parser.add_argument('--dbuser', help='Specify user to use to connect '
                                         'to TagOpsDB',
                                    default=None)

    create_subparsers(parser)

    return parser.parse_args()


def check_user_auth(user):
    """ """

    user_level = get_access_level()

    if user_level is None:
        print 'Your account (%s) is not allowed to run this application.\n' \
              'Please refer to your manager for assistance.' % user
        sys.exit(1)

    return user_level


def get_basic_config():
    """ """

    with open('/etc/tagops/deploy.conf') as conf_file:
        config = ConfigParser.SafeConfigParser()
        config.readfp(conf_file)

    return { 'env' : config.get('env', 'environment'),
             'build_base' : config.get('repo', 'build_base'),
             'incoming' : config.get('repo', 'incoming'),
             'processing' : config.get('repo', 'processing'), }


def initialize_db(args):
    """ """

    if args.dbuser:
        db_user = args.dbuser
        db_password = args.dbpassword
    else:
        dbaccess_file = '/etc/tagops/dbaccess.%s.conf' % args.user_level
        with open(dbaccess_file) as conf_file:
            config = ConfigParser.SafeConfigParser()
            config.readfp(conf_file)

        db_user = config.get('db', 'user')
        db_password = config.get('db', 'password')

    try:
        init_session(db_user, db_password, echo=args.verbose)
    except PermissionsException, e:
        print 'Access issue with database:'
        print e
        sys.exit(1)


if __name__ == '__main__':
    args = parse_command_line()

    # Slight hack: ensure only one of '--hosts', '--apptypes'
    # or '--all-apptypes' is used at a given time
    excl = filter(None, (getattr(args, 'hosts', None),
                         getattr(args, 'apptypes', None),
                         getattr(args, 'all_apptypes', None)))

    if len(excl) > 1:
        print 'Only one of the "--hosts", "--apptypes" or "--all-apptypes" ' \
              'options may be used at a given time'
        sys.exit(1)

    # Set parameter to check for explicit hosts/apptypes
    if not excl:
        args.explicit = False
    else:
        args.explicit = True

    # Pass user through with arguments
    args.user = pwd.getpwuid(os.getuid()).pw_name
    args.user_level = check_user_auth(args.user)
    basic_config = get_basic_config()
    args.environment = basic_config['env']
    args.repo = { 'build_base' : basic_config['build_base'],
                  'incoming' : basic_config['incoming'],
                  'processing' : basic_config['processing'], }

    if args.dbuser:
        args.dbpassword = getpass.getpass('Enter DB password: ')

    initialize_db(args)
    cmd = getattr(tds.commands, args.command_name.capitalize())()

    try:
        getattr(cmd, args.subcommand_name.replace('-', '_'))(args)
    except AccessError:
        print 'Your account (%s) does not have the appropriate permissions' \
              '\nto run the requested command.' % args.user
        sys.exit(1)
    except (NotImplementedError, WrongEnvironmentError,
            WrongProjectTypeError), e:
        print e
        sys.exit(1)
